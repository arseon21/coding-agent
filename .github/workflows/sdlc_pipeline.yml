name: AI SDLC Pipeline

on:
  # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–∞–ø—É—Å–∫ Code Agent –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Issue
  issues:
    types: [opened]
  
  # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏ AI Reviewer –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ PR
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write      # –î–ª—è –ø—É—à–∞ –∫–æ–¥–∞ –∏ —á—Ç–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
  pull-requests: write # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PR –∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
  issues: read         # –î–ª—è —á—Ç–µ–Ω–∏—è –∑–∞–¥–∞—á

jobs:
  # ==========================================================
  # JOB 1: Code Agent (–û–±—Ä–∞–±–æ—Ç–∫–∞ Issue)
  # ==========================================================
  code_agent:
    name: AI Code Agent
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –ø—É—à –æ—Ç –∞–≥–µ–Ω—Ç–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∏–ª –¥—Ä—É–≥–∏–µ workflow (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–≤—å—é),
          # –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PAT (Personal Access Token), –∞ –Ω–µ GITHUB_TOKEN.
          # token: ${{ secrets.PAT_TOKEN }} 
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Configure Git User
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ git, —á—Ç–æ–±—ã –∫–æ–º–º–∏—Ç—ã –æ—Ç –∞–≥–µ–Ω—Ç–∞ –±—ã–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω—ã
        run: |
          git config --global user.name "AI Agent"
          git config --global user.email "ai-agent@users.noreply.github.com"

      - name: Run Code Agent
        env:
          # –°–µ–∫—Ä–µ—Ç—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          LLM_API_KEY: ${{ secrets.YANDEX_API_KEY }}
          # –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏—è
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          repo_owner: ${{ github.repository_owner }}
          repo_name: ${{ github.event.repository.name }}
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º CLI –∞–≥–µ–Ω—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
          python main.py solve --issue-id "$ISSUE_NUMBER"

  # ==========================================================
  # JOB 2: CI & AI Reviewer (–ü—Ä–æ–≤–µ—Ä–∫–∞ PR)
  # ==========================================================
  ai_reviewer:
    name: üïµÔ∏è AI Reviewer & Tests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Tests (Pytest)
        id: run_tests
        # continue-on-error: true ‚Äî —á—Ç–æ–±—ã Reviewer –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏.
        # –ú—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã AI –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –æ—à–∏–±–∫–∏ —Ç–µ—Å—Ç–æ–≤.
        continue-on-error: true
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–≤–æ–¥ –≤ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–≥–µ–Ω—Ç–æ–º
          pytest --junitxml=test-report.xml > test_output.txt 2>&1 || true
          # –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ª–æ–≥–æ–≤ CI
          cat test_output.txt

      - name: Run AI Reviewer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          PR_NUMBER: ${{ github.event.number }}
          repo_owner: ${{ github.repository_owner }}
          repo_name: ${{ github.event.repository.name }}
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º CLI –∞–≥–µ–Ω—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–≤—å—é
          # –ü–µ—Ä–µ–¥–∞–µ–º –ø—É—Ç—å –∫ –ª–æ–≥–∞–º —Ç–µ—Å—Ç–æ–≤, —á—Ç–æ–±—ã AI –º–æ–≥ –∏—Ö –ø—Ä–æ—á–∏—Ç–∞—Ç—å
          python main.py review --pr-id "$PR_NUMBER" --test-log "test_output.txt"
        
      - name: Fail Workflow if Tests Failed
        # –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏, –º—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–Ω—ã –ø–æ–º–µ—Ç–∏—Ç—å Job –∫–∞–∫ failed,
        # –Ω–æ –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ AI –æ—Å—Ç–∞–≤–∏—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
        if: steps.run_tests.outcome == 'failure'
        run: exit 1